using System.Collections;
using UnityEngine;
using Random = UnityEngine.Random;

public class MalwareSpawner : MonoBehaviour
{
    ObjectPooling objectPool;
    GameManager gameManager;
    [SerializeField] GameObject bluePivot;
    [SerializeField] GameObject greenPivot;
    float songRPM;
    int difficultyNum;
    int emptyCounter = 0;
    void Start()
    {
        FindScriptsOnScene();
        StartCoroutine(nameof(SpawnMalwares));
        FindSongRPM();
        DefineDifficultyNum();
    }

    void FindSongRPM() => songRPM = gameManager.songRPM;
    
    void DefineDifficultyNum() => difficultyNum = gameManager.difficultyLevel;

    void FindScriptsOnScene()
    {
        objectPool = FindObjectOfType<ObjectPooling>();
        gameManager = FindObjectOfType<GameManager>();
    }

    IEnumerator SpawnMalwares()
    {
        yield return new WaitForSeconds(songRPM);

        int blueorGreenNum = Random.Range(0, 2);

        int possibility = Random.Range(1, difficultyNum); //Spawn if possiblity = 1

        if (difficultyNum == 3)
        {
            if (possibility != 1)
            {
                if (emptyCounter > 2)
                {
                    if (blueorGreenNum == 0) //0 = BlueSpawn
                    {
                        SpawnFromPool("BlueMalware", bluePivot.transform.position);
                    }
                    else
                    {
                        SpawnFromPool("GreenMalware", greenPivot.transform.position);
                    }

                    emptyCounter = 0;
                }
                else
                {
                    emptyCounter++;
                }
            }
        }
        
        if (possibility == 1)
        {
            int malwareorTrojan = Random.Range(0, 15);

            if (malwareorTrojan == 14)
            {
                if (blueorGreenNum == 0)
                {
                    Vector3 posTrojan = new Vector3(bluePivot.transform.position.x + 0.13f,
                        bluePivot.transform.position.y - 0.34f, bluePivot.transform.position.z);
                    
                    SpawnFromPool("Trojan", posTrojan);
                }
                else
                {
                    Vector3 posTrojan = new Vector3(greenPivot.transform.position.x - 0.13f,
                        greenPivot.transform.position.y - 0.34f, greenPivot.transform.position.z);
                    
                    SpawnFromPool("Trojan", posTrojan);
                }
            }
            else
            {
                if (blueorGreenNum == 0) //0 = BlueSpawn
                {
                    SpawnFromPool("BlueMalware", bluePivot.transform.position);
                }
                else
                {
                    SpawnFromPool("GreenMalware", greenPivot.transform.position);
                }
            }
        }
        
        StartCoroutine(nameof(SpawnMalwares));
    }

    void SpawnFromPool(string tag, Vector3 position) => objectPool.SpawnFromPool(tag, position);
}
